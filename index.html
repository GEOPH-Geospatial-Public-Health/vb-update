<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="sakura.css" />
    <title>WebUSB DFU</title>
    <script src="dfu.js"></script>
    <script src="dfuse.js"></script>
    <script src="FileSaver.js"></script>
    <script src="dfu-util.js"></script>
    <style>
        p.warning {
            color: red;
        }
        p.error {
            color: red;
            font-weight: bold;
        }
        label.radio {
            display: inline;
        }
        input:invalid {
            color: red;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <p><span id="status"></span></p>
    <p>
        <label for="vid">Vendor ID (hex):</label>
        <input type="text" name="vid" id="vid" value="0x0483" readonly />
    </p>
    <p><button id="connect">Connect</button></p>
    <dialog id="interfaceDialog">
        Your device has multiple DFU interfaces. Select one from the list below:
        <form id="interfaceForm" method="dialog">
            <button id="selectInterface" type="submit">Select interface</button>
        </form>
    </dialog>
    <p>
        <div id="usbInfo" style="white-space: pre"></div>
        <div id="dfuInfo" style="white-space: pre"></div>
    </p>
    <fieldset>
        <legend>Runtime mode</legend>
        <button id="detach" disabled="true">Detach DFU</button>
    </fieldset>
    <fieldset>
        <form id="configForm">
            <label for="transferSize">Transfer Size:</label>
            <input type="number" name="transferSize" id="transferSize" value="1024"/>
            <div id="dfuseFields" hidden="true">
                <label for="dfuseStartAddress">DfuSe Start Address:</label>
                <input type="text" name="dfuseStartAddress" id="dfuseStartAddress" title="Initial memory address to read/write from (hex)" size="10" pattern="0x[A-Fa-f0-9]+"/>
                <label for="dfuseUploadSize">DfuSe Upload Size:</label>
                <input type="number" name="dfuseUploadSize" id="dfuseUploadSize" min="1"/>
            </div>
            <legend>DFU mode</legend>
            <fieldset>
                <legend>Firmware Download (write to USB device)</legend>
                <p><input type="file" id="firmwareFile" name="file" disabled="true"/></p>
                <p><button id="download" disabled="true">Download</button></p>
                <div class="log" id="downloadLog"></div>
            </fieldset>
            <fieldset>
                <legend>Firmware Upload (read from USB device)</legend>
                <p><button id="upload" disabled="true">Upload</button></p>
                <div class="log" id="uploadLog"></div>
            </fieldset>
        </form>
    </fieldset>
    <h1>Directions</h1>
    <p>Todo: Provide detailed directions here.</p>
    <h2>Available Firmware</h2>
    <fieldset>
        <legend>Firmware Options</legend>
        <div>
            <label for="firmwareSelection">Select Firmware:</label>
            <select id="firmwareSelection"></select>
        </div>
    </fieldset>
    <table>
        <thead>
            <tr>
                <th>Filename</th>
                <th>Last Modified Date</th>
            </tr>
        </thead>
        <tbody id="other-binaries">
            <tr>
                <td colspan="2">Loading...</td>
            </tr>
        </tbody>
    </table>

    <script>
        const org = 'GEOPH-Geospatial-Public-Health';
        const repo = 'releases';
        const project = 'VaccineBuddy';

        async function getFirmwareOptions() {
            const url = `https://api.github.com/repos/${org}/${repo}/contents/${project}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.filter(file => file.name.endsWith('.bin')).sort((a, b) => a.name.localeCompare(b.name));
        }

        async function populateFirmwareOptions() {
            const firmwareSelection = document.getElementById('firmwareSelection');
            firmwareSelection.innerHTML = '';
            const options = await getFirmwareOptions();
            options.forEach(file => {
                const option = document.createElement('option');
                option.value = `https://raw.githubusercontent.com/${org}/${repo}/main/${project}/${file.name}`;
                option.textContent = file.name;
                firmwareSelection.appendChild(option);
            });
        }

        async function populateOtherBinariesTable() {
            const tbody = document.getElementById('other-binaries');
            tbody.innerHTML = '';
            const options = await getFirmwareOptions();
            options.forEach(file => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                const dateCell = document.createElement('td');
                const link = document.createElement('a');
                link.href = `https://raw.githubusercontent.com/${org}/${repo}/main/${project}/${file.name}`;
                link.textContent = file.name;
                nameCell.appendChild(link);
                const lastModified = new Date(file.commit.author.date).toISOString().split('T')[0];
                dateCell.textContent = lastModified;
                row.appendChild(nameCell);
                row.appendChild(dateCell);
                tbody.appendChild(row);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await populateFirmwareOptions();
            await populateOtherBinariesTable();
            const firmwareSelection = document.getElementById('firmwareSelection');
            firmwareSelection.addEventListener('change', () => {
                const firmwareFileField = document.getElementById('firmwareFile');
                firmwareFileField.disabled = true;
                const selectedFirmware = firmwareSelection.value;
                const downloadButton = document.getElementById('download');
                downloadButton.onclick = () => {
                    window.location.href = selectedFirmware;
                };
                downloadButton.disabled = false;
            });
        });

        // The existing event listeners and functions for connecting to the device and handling DFU operations should remain unchanged
    </script>
</body>
</html>
